name: Continuous Deployment

on:
  push:
    branches: [ main, ManHou ]
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        default: staging
        type: choice
        options: [ staging, production ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Docker version
        run: |
          docker --version
          docker compose version || true

      - name: Make deploy script executable
        run: chmod +x automation/deploy.sh

      # If deploy.sh uses "docker-compose", the runner might not have v1.
      # Prefer "docker compose" inside the script. Otherwise install docker-compose v1
      # or adapt deploy.sh to pick whichever is available.

      - name: Run deployment
        env:
          # default to 'staging' when triggered by push (no inputs)
          TARGET_ENV: ${{ inputs.environment || 'staging' }}
        run: |
          cd automation
          ./deploy.sh "$TARGET_ENV"

      - name: Upload deployment report & logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-${{ github.run_id }}
          if-no-files-found: ignore
          retention-days: 14
          path: |
            automation/deployment-report-*.json
            automation/deploy_*.log
            deployment-report-*.json
            deploy_*.log
